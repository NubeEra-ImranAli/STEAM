{% extends 'student/studentbase.html' %} {% block content %} {% load static %}
<link rel="stylesheet" href="/static/get/css/style.css" />
<style>
  ol.breadcrumb li + li:before {
    content: "\f061";
    display: inline-block;
    font-family: "fontAwesome";
    padding: 0 10px;
  }
  #player {
    display: none;
  }
</style>
<div>
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li>
        <a href="{% url 'user-dashboard' %}">Dashboard</a>
      </li>
      <li aria-current="page">View Study Kit</li>
    </ol>
  </nav>
</div>

{% if messages %} {% for message in messages %}
<div class="alert alert-info" id="success-message">{{ message }}</div>
{% endfor %} {% endif %}

<script>
  document.addEventListener("DOMContentLoaded", function () {
    var message = document.getElementById("success-message");
    if (message) {
      setTimeout(function () {
        message.style.display = "none";
      }, 5000);
    }
  });
</script>

<div class="container-fluid">
  <div class="row">
    <div class="col-xl-8 col-xxl-7">
      <div class="card">
        <div id="lesson-details" class="card-body">
          <div id="player" style="display: none"></div>
          <img
            id="video-placeholder"
            src="/static/image/girls_working.jpeg"
            alt="Video Placeholder"
            style="width: 100%; cursor: pointer"
          />

          <!-- Tabs for displaying content -->
          <div class="course-details-tab style-2 mt-4">
            <nav>
              <div class="nav nav-tabs tab-auto" id="nav-tab" role="tablist">
                <button
                  class="nav-link active"
                  id="nav-about-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#nav-about"
                  type="button"
                  role="tab"
                  aria-controls="nav-about"
                  aria-selected="true"
                >
                  About
                </button>
                <button
                  class="nav-link"
                  id="nav-reqmaterial-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#nav-reqmaterial"
                  type="button"
                  role="tab"
                  aria-controls="nav-reqmaterial"
                  aria-selected="false"
                >
                  Required Material
                </button>
                <button
                  class="nav-link"
                  id="nav-digram-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#nav-digram"
                  type="button"
                  role="tab"
                  aria-controls="nav-digram"
                  aria-selected="false"
                >
                  Circuit Diagram
                </button>
                <button
                  class="nav-link"
                  id="nav-code-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#nav-code"
                  type="button"
                  role="tab"
                  aria-controls="nav-code"
                  aria-selected="false"
                >
                  Code
                </button>
                <button
                  class="nav-link"
                  id="nav-process-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#nav-process"
                  type="button"
                  role="tab"
                  aria-controls="nav-process"
                  aria-selected="false"
                >
                  Procedure
                </button>
                <button
                  class="nav-link"
                  id="nav-get-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#nav-get"
                  type="button"
                  role="tab"
                  aria-controls="nav-get"
                  aria-selected="false"
                >
                  What You Get
                </button>
              </div>
            </nav>
            <div class="tab-content" id="nav-tabContent">
              <div
                class="tab-pane fade show active"
                id="nav-about"
                role="tabpanel"
                aria-labelledby="nav-about-tab"
              >
                <div class="about-content">
                  Select a lesson to view details.
                </div>
              </div>
              <div
                class="tab-pane fade"
                id="nav-reqmaterial"
                role="tabpanel"
                aria-labelledby="nav-reqmaterial-tab"
              >
                Required Material content will appear here.
              </div>
              <div
                class="tab-pane fade"
                id="nav-digram"
                role="tabpanel"
                aria-labelledby="nav-digram-tab"
              >
                Circuit Diagram content will appear here.
              </div>
              <div
                class="tab-pane fade"
                id="nav-code"
                role="tabpanel"
                aria-labelledby="nav-code-tab"
              >
                Code content will appear here.
              </div>
              <div
                class="tab-pane fade"
                id="nav-process"
                role="tabpanel"
                aria-labelledby="nav-process-tab"
              >
                Procedure content will appear here.
              </div>
              <div
                class="tab-pane fade"
                id="nav-get"
                role="tabpanel"
                aria-labelledby="nav-get-tab"
              >
                What You Get content will appear here.
              </div>
            </div>
          </div>
        </div>

        <div id="questions-details" class="card-body">
          <div id="questions-container" class="mt-3"></div>
        </div>
      </div>
    </div>

    <div class="col-xl-4 col-xxl-5">
      <div class="custome-accordion">
        {% for module_name, lessons in grouped_lessons.items %}
        <div class="accordion-item card">
          <h2 class="accordion-header" id="heading{{ forloop.counter }}">
            <button
              class="accordion-button d-flex justify-content-between align-items-center collapsed"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#collapse{{ forloop.counter }}"
              aria-expanded="false"
              aria-controls="collapse{{ forloop.counter }}"
            >
              <span class="acc-heading">{{ module_name }}</span>
              <span class="ms-auto">({{ lessons|length }})</span>
            </button>
          </h2>
          <div
            id="collapse{{ forloop.counter }}"
            class="accordion-collapse collapse"
            aria-labelledby="heading{{ forloop.counter }}"
            data-bs-parent="#accordionExample"
          >
            <div class="accordion-body card-body pt-0">
              {% for lesson in lessons %}
              <div class="acc-courses">
                <div class="d-flex justify-content-between align-items-center">
                  <h4
                    class="m-0 lesson-heading"
                    data-lesson-id="{{ lesson.id }}"
                  >
                    {{ lesson.heading }}
                  </h4>
                  <span>{{ lesson.serialno }}</span>
                </div>
              </div>
              {% endfor %}

              <!-- Separate heading for Exam availability -->
              {% with last_lesson=lessons|last %} {% if last_lesson.has_ques %}
              <div class="acc-courses">
                <div class="d-flex justify-content-between align-items-center">
                  <h4
                    class="m-0 lesson-heading exam-heading"
                    data-lesson-id="{{ last_lesson.id }}"
                  >
                    Exam
                  </h4>
                </div>
              </div>
              {% endif %} {% endwith %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  var playerReady = false; // Track if the player is ready

  // Load the IFrame Player API code asynchronously.
  var tag = document.createElement("script");
  tag.src = "https://www.youtube.com/iframe_api";
  var firstScriptTag = document.getElementsByTagName("script")[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

  var player;

  // This function creates an <iframe> (and YouTube player) after the API code downloads.
  function onYouTubeIframeAPIReady() {
    player = new YT.Player("player", {
      height: "500",
      width: "100%",
      playerVars: { playsinline: 1 },
      events: {
        onReady: onPlayerReady,
        onStateChange: onPlayerStateChange,
      },
    });
  }

  function onPlayerReady(event) {
    playerReady = true; // Set player ready to true
  }

  var done = false;
  function onPlayerStateChange(event) {
    if (event.data == YT.PlayerState.PLAYING && !done) {
      setTimeout(stopVideo, 6000);
      done = true;
    }
  }

  function stopVideo() {
    if (player) {
      player.stopVideo();
    }
  }

  $(document).ready(function () {
    // Handle lesson heading click
    $(".lesson-heading").on("click", function () {
      document.getElementById("lesson-details").style.display = "block";
      document.getElementById("questions-details").style.display = "none";
      var lessonId = $(this).data("lesson-id");
      var url = "{% url 'get-lesson-details' 0 %}".replace("0", lessonId);

      // AJAX request to get lesson details
      $.ajax({
        url: url,
        method: "GET",
        success: function (data) {
          // Populate the card-body with the fetched lesson details
          $("#nav-about .about-content").html(data.about);
          $("#nav-reqmaterial").html(data.reqmaterial);
          $("#nav-digram").html(data.digram);
          $("#nav-code").html(data.code);
          $("#nav-process").html(data.process);
          $("#nav-get").html(data.get);

          // Show or hide video player
          if (playerReady && data.video) {
            $("#video-placeholder").hide();
            player.loadVideoById(data.video);
            $("#player").show();
          } else {
            $("#video-placeholder").show();
            player.stopVideo();
            $("#player").hide();
          }

          // Update the progress bar
          updateProgressBar(lessonId);
        },
        error: function (xhr, status, error) {
          console.error("Error fetching lesson details:", error);
        },
      });
    });

    // Handle exam heading click
    $(".exam-heading").on("click", function () {
      var lessonId = $(this).data("lesson-id");
      var url = "{% url 'get-module-questions' 0 %}".replace("0", lessonId);

      // AJAX request to get module questions
      $.ajax({
        url: url,
        method: "GET",
        success: function (data) {
          // Display questions in the card-body
          displayModuleQuestions(data.questions);
        },
        error: function (xhr, status, error) {
          console.error("Error fetching module questions:", error);
        },
      });
    });

    let currentQuestionIndex = 0; // To track the current question
    let questions = []; // Store questions globally
    let selectedAnswers = []; // Array to keep track of selected answers

    function displayModuleQuestions(ques) {
      questions = ques; // Store questions in the global variable
      currentQuestionIndex = 0; // Reset index
      selectedAnswers = Array(questions.length).fill(null); // Initialize selected answers
      document.getElementById("lesson-details").style.display = "none";
      document.getElementById("questions-details").style.display = "block";
      showQuestion(currentQuestionIndex); // Display the first question
    }

    function showQuestion(index) {
      const questionsContainer = $("#questions-container");
      questionsContainer.empty(); // Clear previous content

      if (questions.length > 0) {
        const question = questions[index];
        const options = [
          question.option1,
          question.option2,
          question.option3,
          question.option4,
        ];
        const optionsList = options
          .map(
            (option, idx) => `
                        <div>
                            <input type="radio" id="option${
                              idx + 1
                            }_question${index}" name="question${index}" value="${
              idx + 1
            }">
                            <label for="option${
                              idx + 1
                            }_question${index}">${option}</label>
                        </div>
                    `
          )
          .join("");

        questionsContainer.append(
          `<div class='question-item'>
                    <h5>${question.question}</h5>
                    <div>${optionsList}</div>
                    <h6>Right Answer: ${question.answer}</h6>
                    <h6>Module : ${question.module_id}</h6>
                    <h6>Grade : ${question.grade_id}</h6>
                </div>`
        );

        // Navigation buttons
        const navigationButtons = `
                <div class="navigation-buttons">
                    ${index > 0 ? '<button id="prevBtn">Previous</button>' : ""}
                    ${
                      index < questions.length - 1
                        ? '<button id="nextBtn">Next</button>'
                        : '<button id="submitBtn">Submit</button>'
                    }
                </div>
            `;
        questionsContainer.append(navigationButtons);

        // Attach event listeners to buttons
        if (index > 0) {
          $("#prevBtn").on("click", function () {
            currentQuestionIndex--;
            showQuestion(currentQuestionIndex);
          });
        }

        if (index < questions.length - 1) {
          $("#nextBtn").on("click", function () {
            const selectedOption = $(
              `input[name="question${index}"]:checked`
            ).val();
            selectedAnswers[index] = selectedOption; // Save selected answer
            currentQuestionIndex++;
            showQuestion(currentQuestionIndex);
          });
        } else {
          $("#submitBtn").on("click", function () {
            const selectedOption = $(
              `input[name="question${index}"]:checked`
            ).val();
            selectedAnswers[index] = selectedOption; // Capture the last question's selected answer

            // Prepare data to send to the server
            const resultsData = questions.map((question, idx) => ({
              questionID: question.id,
              givenAnswer:
                selectedAnswers[idx] !== null
                  ? selectedAnswers[idx]
                  : "Not answered",
              moduleID: question.module_id,
              gradeID: question.grade_id,
            }));

            // AJAX request to submit results
            $.ajax({
              url: "{% url 'submit-quiz' %}", // Update with your actual URL
              type: "POST",
              data: JSON.stringify(resultsData),
              contentType: "application/json",
              success: function (response) {
                let resultHtml = `
        <h4>Results:</h4>
        <p>Total Correct: ${response.totalCorrect} out of ${response.totalQuestions}</p>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Question ID</th>
                    <th>Given Answer</th>
                    <th>Result</th>
                </tr>
            </thead>
            <tbody>
    `;

                response.results.forEach((result) => {
                  resultHtml += `
            <tr>
                <td>${result.questionID}</td>
                <td>${result.givenAnswer}</td>
                <td>${result.result}</td>
            </tr>
        `;
                });

                resultHtml += `
            </tbody>
        </table>
    `;

                $("#questions-container").html(resultHtml);
              },
              error: function (xhr, status, error) {
                console.error("Error submitting results:", error);
              },
            });
          });
        }
      } else {
        questionsContainer.append(
          "<p>No questions available for this exam.</p>"
        );
      }
    }

    // Helper function to escape HTML
    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
  });
</script>
{% endblock %}
