{% extends 'student/studentbase.html' %} {% block content %} {% load static %}
<link rel="stylesheet" href="/static/get/css/style.css" />
<style>
  ol.breadcrumb li + li:before {
    content: "\f061";
    display: inline-block;
    font-family: "fontAwesome";
    padding: 0 10px;
  }
  #player {
    display: none;
  }
  /* .question-item h5 {
    font-size: 32px; 
  }

  .form-check-label {
    font-size: 28px; 
  } */
</style>
<div>
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li>
        <a href="{% url 'user-dashboard' %}">Dashboard</a>
      </li>
      <li aria-current="page">View Study Kit</li>
    </ol>
  </nav>
</div>

{% if messages %} {% for message in messages %}
<div class="alert alert-info" id="success-message">{{ message }}</div>
{% endfor %} {% endif %}

<script>
  document.addEventListener("DOMContentLoaded", function () {
    var message = document.getElementById("success-message");
    if (message) {
      setTimeout(function () {
        message.style.display = "none";
      }, 5000);
    }
  });
</script>

<div class="container-fluid">
  <div class="row">
    <div class="col-xl-8 col-xxl-7">
      <div class="card">
        <div id="lesson-details" class="card-body">
          <div id="player" style="display: none"></div>
          <img
            id="video-placeholder"
            src="/static/image/girls_working.jpeg"
            alt="Video Placeholder"
            style="width: 100%; cursor: pointer"
          />

          <!-- Tabs for displaying content -->
          <div class="course-details-tab style-2 mt-4">
            <nav>
              <div class="nav nav-tabs tab-auto" id="nav-tab" role="tablist">
                <button
                  class="nav-link active"
                  id="nav-about-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#nav-about"
                  type="button"
                  role="tab"
                  aria-controls="nav-about"
                  aria-selected="true"
                >
                  About
                </button>
                <button
                  class="nav-link"
                  id="nav-reqmaterial-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#nav-reqmaterial"
                  type="button"
                  role="tab"
                  aria-controls="nav-reqmaterial"
                  aria-selected="false"
                >
                  Required Material
                </button>
                <button
                  class="nav-link"
                  id="nav-digram-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#nav-digram"
                  type="button"
                  role="tab"
                  aria-controls="nav-digram"
                  aria-selected="false"
                >
                  Circuit Diagram
                </button>
                <button
                  class="nav-link"
                  id="nav-code-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#nav-code"
                  type="button"
                  role="tab"
                  aria-controls="nav-code"
                  aria-selected="false"
                >
                  Code
                </button>
                <button
                  class="nav-link"
                  id="nav-process-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#nav-process"
                  type="button"
                  role="tab"
                  aria-controls="nav-process"
                  aria-selected="false"
                >
                  Procedure
                </button>
                <button
                  class="nav-link"
                  id="nav-get-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#nav-get"
                  type="button"
                  role="tab"
                  aria-controls="nav-get"
                  aria-selected="false"
                >
                  What You Get
                </button>
              </div>
            </nav>
            <div class="tab-content" id="nav-tabContent">
              <div
                class="tab-pane fade show active"
                id="nav-about"
                role="tabpanel"
                aria-labelledby="nav-about-tab"
              >
                <div class="about-content">
                  Select a lesson to view details.
                </div>
              </div>
              <div
                class="tab-pane fade"
                id="nav-reqmaterial"
                role="tabpanel"
                aria-labelledby="nav-reqmaterial-tab"
              >
                Required Material content will appear here.
              </div>
              <div
                class="tab-pane fade"
                id="nav-digram"
                role="tabpanel"
                aria-labelledby="nav-digram-tab"
              >
                Circuit Diagram content will appear here.
              </div>
              <div
                class="tab-pane fade"
                id="nav-code"
                role="tabpanel"
                aria-labelledby="nav-code-tab"
              >
                Code content will appear here.
              </div>
              <div
                class="tab-pane fade"
                id="nav-process"
                role="tabpanel"
                aria-labelledby="nav-process-tab"
              >
                Procedure content will appear here.
              </div>
              <div
                class="tab-pane fade"
                id="nav-get"
                role="tabpanel"
                aria-labelledby="nav-get-tab"
              >
                What You Get content will appear here.
              </div>
            </div>
          </div>
        </div>
        <div id="result-generating" style="display: none; text-align: center">
          <h4>Generating results, please wait...</h4>
        </div>
        <div id="questions-details" class="card-body">
          <div id="questions-container" class="mt-3"></div>
          <canvas id="resultsChart"></canvas>
        </div>
      </div>
    </div>

    <div class="col-xl-4 col-xxl-5">
      <div class="custome-accordion">
        {% for module_name, lessons in grouped_lessons.items %}
        <div class="accordion-item card">
          <h2 class="accordion-header" id="heading{{ forloop.counter }}">
            <button
              class="accordion-button d-flex justify-content-between align-items-center collapsed"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#collapse{{ forloop.counter }}"
              aria-expanded="false"
              aria-controls="collapse{{ forloop.counter }}"
            >
              <span class="acc-heading">{{ module_name }}</span>
              <span class="ms-auto">({{ lessons|length }})</span>
            </button>
          </h2>
          <div
            id="collapse{{ forloop.counter }}"
            class="accordion-collapse collapse"
            aria-labelledby="heading{{ forloop.counter }}"
            data-bs-parent="#accordionExample"
          >
            <div class="accordion-body card-body pt-0">
              {% for lesson in lessons %}
              <div class="acc-courses">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="d-flex align-items-center">
                    <span class="acc-icon">
                      {% if lesson.watched_status_display == 'YES' %}
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M4 13C3.817 13 3.635 12.95 3.474 12.851C3.32918 12.7611 3.20965 12.6358 3.12671 12.4869C3.04378 12.338 3.00016 12.1704 3 12V4C3 3.653 3.18 3.331 3.474 3.149C3.61914 3.05976 3.7846 3.00891 3.95481 3.00121C4.12502 2.99351 4.29439 3.02923 4.447 3.105L12.447 7.105C12.6131 7.1882 12.7528 7.31599 12.8504 7.47405C12.948 7.63212 12.9997 7.81423 12.9997 8C12.9997 8.18578 12.948 8.36789 12.8504 8.52595C12.7528 8.68402 12.6131 8.8118 12.447 8.895L4.447 12.895C4.307 12.965 4.152 13 4 13Z" fill="var(--primary)"></path>
                      </svg>
                    </span>	
                    <h4
                    class="m-0 lesson-heading"
                  data-lesson-id="{{ lesson.id }}"
                  >
                  {% else %}
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M11.3337 6V4.66666C11.3337 2.79999 9.86699 1.33333 8.00033 1.33333C6.13366 1.33333 4.66699 2.79999 4.66699 4.66666V6C3.53366 6 2.66699 6.86666 2.66699 8V12.6667C2.66699 13.8 3.53366 14.6667 4.66699 14.6667H11.3337C12.467 14.6667 13.3337 13.8 13.3337 12.6667V8C13.3337 6.86666 12.467 6 11.3337 6ZM6.00033 4.66666C6.00033 3.53333 6.86699 2.66666 8.00033 2.66666C9.13366 2.66666 10.0003 3.53333 10.0003 4.66666V6H6.00033V4.66666ZM8.66699 11.3333C8.66699 11.7333 8.40033 12 8.00033 12C7.60033 12 7.33366 11.7333 7.33366 11.3333V9.33333C7.33366 8.93333 7.60033 8.66666 8.00033 8.66666C8.40033 8.66666 8.66699 8.93333 8.66699 9.33333V11.3333Z" fill="#374557"></path>
                  </svg>
                  </span>	
                  <h4
                  class="m-0"

                >
                  {% endif %}
                  {{ lesson.heading }}</h4>

                  
                  </div>	
                </div>
              </div>
              {% endfor %}

              <!-- Separate heading for Exam availability -->
              {% with last_lesson=lessons|last %} 
              {% if last_lesson.has_ques and last_lesson.watched_status_display == 'YES' %}

              <div class="acc-courses">
                <div class="d-flex justify-content-between align-items-center">
                  <div class="d-flex align-items-center">
                    <span class="acc-icon">
                      
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="2" y="2" width="12" height="12" fill="white" stroke="var(--primary)" stroke-width="1"/>
                        <line x1="3" y1="4" x2="13" y2="4" stroke="var(--primary)" stroke-width="0.5"/>
                        <line x1="3" y1="6" x2="13" y2="6" stroke="var(--primary)" stroke-width="0.5"/>
                        <line x1="3" y1="8" x2="13" y2="8" stroke="var(--primary)" stroke-width="0.5"/>
                        <line x1="3" y1="10" x2="13" y2="10" stroke="var(--primary)" stroke-width="0.5"/>
                        <line x1="3" y1="12" x2="8" y2="12" stroke="var(--primary)" stroke-width="0.5"/>
                        
                        <path d="M10 1L11.5 2.5L5 9L4 10.5L3.5 11.5L3 11L2 10L8.5 3.5L10 1Z" fill="var(--primary)"/>
                      </svg>
                      
                    </span>	
                    <h4
                    class="m-0 lesson-heading exam-heading"
                    data-lesson-id="{{ last_lesson.id }}"
                  >
                  
                  Exam</h4>

                  
                  </div>	
                </div>
              </div>
              
              {% endif %} {% endwith %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  var playerReady = false; // Track if the player is ready

  // Load the IFrame Player API code asynchronously.
  var tag = document.createElement("script");
  tag.src = "https://www.youtube.com/iframe_api";
  var firstScriptTag = document.getElementsByTagName("script")[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

  var player;

  // This function creates an <iframe> (and YouTube player) after the API code downloads.
  function onYouTubeIframeAPIReady() {
    player = new YT.Player("player", {
      height: "500",
      width: "100%",
      playerVars: { playsinline: 1 },
      events: {
        onReady: onPlayerReady,
        onStateChange: onPlayerStateChange,
      },
    });
  }

  function onPlayerReady(event) {
    playerReady = true; // Set player ready to true
  }

  var done = false;
  function onPlayerStateChange(event) {
    if (event.data == YT.PlayerState.PLAYING && !done) {
      setTimeout(stopVideo, 6000);
      done = true;
    }
  }

  function stopVideo() {
    if (player) {
      player.stopVideo();
    }
  }

  $(document).ready(function () {
    // Handle lesson heading click
    $(".lesson-heading").on("click", function () {
      document.getElementById("lesson-details").style.display = "block";
      document.getElementById("questions-details").style.display = "none";
      $("#resultsChart").hide();
      var lessonId = $(this).data("lesson-id");
      var url = "{% url 'get-lesson-details' 0 %}".replace("0", lessonId);

      // AJAX request to get lesson details
      $.ajax({
        url: url,
        method: "GET",
        success: function (data) {
          // Populate the card-body with the fetched lesson details
          $("#nav-about .about-content").html(data.about);
          $("#nav-reqmaterial").html(data.reqmaterial);
          $("#nav-digram").html(data.digram);
          $("#nav-code").html(data.code);
          $("#nav-process").html(data.process);
          $("#nav-get").html(data.get);

          // Show or hide video player
          if (playerReady && data.video) {
            $("#video-placeholder").hide();
            player.loadVideoById(data.video);
            $("#player").show();
          } else {
            $("#video-placeholder").show();
            player.stopVideo();
            $("#player").hide();
          }

          // Update the progress bar
          updateProgressBar(lessonId);
        },
        error: function (xhr, status, error) {
          console.error("Error fetching lesson details:", error);
        },
      });
    });

    // Handle exam heading click
    $(".exam-heading").on("click", function () {
      var lessonId = $(this).data("lesson-id");
      window.scrollTo({ top: 0, behavior: "smooth" });
      var url = "{% url 'get-module-questions' 0 %}".replace("0", lessonId);

      // AJAX request to get module questions
      $.ajax({
        url: url,
        method: "GET",
        success: function (data) {
          // Display questions in the card-body
          displayModuleQuestions(data.questions);
        },
        error: function (xhr, status, error) {
          console.error("Error fetching module questions:", error);
        },
      });
    });

    let currentQuestionIndex = 0; // To track the current question
    let questions = []; // Store questions globally
    let selectedAnswers = []; // Array to keep track of selected answers

    function displayModuleQuestions(ques) {
      questions = ques; // Store questions in the global variable
      currentQuestionIndex = 0; // Reset index
      selectedAnswers = Array(questions.length).fill(null); // Initialize selected answers
      document.getElementById("lesson-details").style.display = "none";
      document.getElementById("questions-details").style.display = "block";
      showQuestion(currentQuestionIndex); // Display the first question
    }

    function showQuestion(index) {
      const questionsContainer = $("#questions-container");
      questionsContainer.empty(); // Clear previous content

      if (questions.length > 0) {
        const question = questions[index];
        const options = [
          question.option1,
          question.option2,
          question.option3,
          question.option4,
        ];
        const optionsList = options
          .map((option, idx) => {
            const checked = selectedAnswers[index] == idx + 1 ? "checked" : "";
            return `
          <div class="form-check">
            <input class="form-check-input" type="radio" id="option${
              idx + 1
            }_question${index}" name="question${index}" value="${
              idx + 1
            }" ${checked}>
            <label class="form-check-label" for="option${
              idx + 1
            }_question${index}">${option}</label>
          </div>
        `;
          })
          .join("");

        questionsContainer.append(`
     <div class='question-item mb-4'>
  <h5 class="mb-3">${question.question}</h5>
  <div>${optionsList}</div>
</div>
    `);

        // Navigation buttons with Bootstrap styles
        const navigationButtons = `
      <div class="navigation-buttons mt-3">
        ${
          index > 0
            ? '<button id="prevBtn" class="btn btn-secondary me-2">Previous</button>'
            : ""
        }
        ${
          index < questions.length - 1
            ? '<button id="nextBtn" class="btn btn-primary">Next</button>'
            : '<button id="submitBtn" class="btn btn-success">Submit</button>'
        }
      </div>
    `;
        questionsContainer.append(navigationButtons);

        // Attach event listeners to buttons
        if (index > 0) {
          $("#prevBtn").on("click", function () {
            currentQuestionIndex--;
            showQuestion(currentQuestionIndex);
          });
        }

        if (index < questions.length - 1) {
          $("#nextBtn").on("click", function () {
            const selectedOption = $(
              `input[name="question${index}"]:checked`
            ).val();
            selectedAnswers[index] = selectedOption; // Save selected answer
            currentQuestionIndex++;
            showQuestion(currentQuestionIndex);
          });
        } else {
          $("#submitBtn").on("click", function () {
            const selectedOption = $(
              `input[name="question${index}"]:checked`
            ).val();
            selectedAnswers[index] = selectedOption; // Capture the last question's selected answer

            // Show generating results label and hide questions
            $("#questions-container").hide();
            $("#result-generating").show(); // Show the generating results label

            // Prepare data to send to the server
            const resultsData = questions.map((question, idx) => ({
              questionID: question.id,
              givenAnswer:
                selectedAnswers[idx] !== null
                  ? selectedAnswers[idx]
                  : "Not answered",
              moduleID: question.module_id,
              gradeID: question.grade_id,
            }));

            // AJAX request to submit results
            $.ajax({
              url: "{% url 'submit-quiz' %}",
              type: "POST",
              data: JSON.stringify(resultsData),
              contentType: "application/json",
              success: function (response) {
                displayResults(response.totalCorrect, response.totalQuestions);
                $("#result-generating").hide(); // Hide generating results label
                // Prepare and display results
                let resultHtml = `
    <h4>Results:</h4>
    <p>Total Correct: ${response.totalCorrect} out of ${response.totalQuestions} (${response.percentage}%)</p>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Question</th>
          <th>Given Answer</th>
          <th>Result</th>
        </tr>
      </thead>
      <tbody>
  `;

                response.results.forEach((result) => {
                  resultHtml += `
      <tr>
        <td>${result.questionID}</td>
        <td>${result.givenAnswer}</td>
        <td>${result.result}</td>
      </tr>
    `;
                });

                resultHtml += `
      </tbody>
    </table>
  `;

                // Update the questions container to show the results
                $("#questions-container").html(resultHtml);
                $("#questions-container").show(); // Ensure the results are visible
                $("#resultsChart").show(); // Show the results chart if it's supposed to be displayed
              },
              error: function (xhr, status, error) {
                console.error("Error submitting results:", error);
              },
            });
          });
        }
      } else {
        questionsContainer.append(
          "<p>No questions available for this exam.</p>"
        );
      }
    }

    // Function to create and display the pie chart
    function displayResults(totalCorrect, totalQuestions) {
      const incorrectAnswers = totalQuestions - totalCorrect;

      const ctx = document.getElementById("resultsChart").getContext("2d");
      const resultsChart = new Chart(ctx, {
        type: "pie",
        data: {
          labels: ["Correct", "Incorrect"],
          datasets: [
            {
              label: "Quiz Results",
              data: [totalCorrect, incorrectAnswers],
              backgroundColor: ["#4caf50", "#f44336"],
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: "top",
            },
            title: {
              display: true,
              text: `Total Correct: ${totalCorrect} out of ${totalQuestions} (${(
                (totalCorrect / totalQuestions) *
                100
              ).toFixed(2)}%)`,
            },
          },
        },
      });
    }
    // Helper function to escape HTML
    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
  });
</script>
{% endblock %}
