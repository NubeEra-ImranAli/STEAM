{% extends 'student/studentbase.html' %} {% block content %} {% load static %}
<link rel="stylesheet" href="/static/get/css/style.css" />
<style>
  ol.breadcrumb li + li:before {
    content: "\f061";
    display: inline-block;
    font-family: "fontAwesome";
    padding: 0 10px;
  }
  #player {
  display: none;
}
</style>
<div>
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li>
        <a href="{% url 'user-dashboard' %}">Dashboard</a>
      </li>
      <li aria-current="page">View Study Kit</li>
    </ol>
  </nav>
</div>
{% if messages %} {% for message in messages %}
<div class="alert alert-info" id="success-message">{{ message }}</div>
{% endfor %} {% endif %}
<script>
  // Wait for the DOM to load
  document.addEventListener("DOMContentLoaded", function () {
    // Select the success message
    var message = document.getElementById("success-message");
    if (message) {
      // Set a timer to hide the message after 5 seconds (5000 ms)
      setTimeout(function () {
        message.style.display = "none";
      }, 5000);
    }
  });
</script>
<div class="container-fluid">
  <div class="row">
    <div class="col-xl-8 col-xxl-7">
      <div class="card">
        <div class="card-body">
          <div id="player" style="display: none;"></div>
          <img id="video-placeholder" src="/static/image/girls_working.jpeg" alt="Video Placeholder" style="width: 100%; cursor: pointer;">
          <!-- Tabs for displaying content -->
          <div class="course-details-tab style-2 mt-4">
            <nav>
              <div class="nav nav-tabs tab-auto" id="nav-tab" role="tablist">
                <button
                  class="nav-link active"
                  id="nav-about-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#nav-about"
                  type="button"
                  role="tab"
                  aria-controls="nav-about"
                  aria-selected="true"
                >
                  About
                </button>
                <button
                  class="nav-link"
                  id="nav-reqmaterial-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#nav-reqmaterial"
                  type="button"
                  role="tab"
                  aria-controls="nav-reqmaterial"
                  aria-selected="false"
                >
                  Required Material
                </button>
                <button
                  class="nav-link"
                  id="nav-digram-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#nav-digram"
                  type="button"
                  role="tab"
                  aria-controls="nav-digram"
                  aria-selected="false"
                >
                  Circuit Diagram
                </button>
                <button
                  class="nav-link"
                  id="nav-code-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#nav-code"
                  type="button"
                  role="tab"
                  aria-controls="nav-code"
                  aria-selected="false"
                >
                  Code
                </button>
                <button
                  class="nav-link"
                  id="nav-process-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#nav-process"
                  type="button"
                  role="tab"
                  aria-controls="nav-process"
                  aria-selected="false"
                >
                  Procedure
                </button>
                <button
                  class="nav-link"
                  id="nav-get-tab"
                  data-bs-toggle="tab"
                  data-bs-target="#nav-get"
                  type="button"
                  role="tab"
                  aria-controls="nav-get"
                  aria-selected="false"
                >
                  What You Get
                </button>
              </div>
            </nav>
            <div class="tab-content" id="nav-tabContent">
              <div
                class="tab-pane fade show active"
                id="nav-about"
                role="tabpanel"
                aria-labelledby="nav-about-tab"
              >
                <div class="about-content">
                  Select a lesson to view details.
                </div>
              </div>
              <div
                class="tab-pane fade"
                id="nav-reqmaterial"
                role="tabpanel"
                aria-labelledby="nav-reqmaterial-tab"
              >
                Required Material content will appear here.
              </div>
              <div
                class="tab-pane fade"
                id="nav-digram"
                role="tabpanel"
                aria-labelledby="nav-digram-tab"
              >
                Circuit Diagram content will appear here.
              </div>
              <div
                class="tab-pane fade"
                id="nav-code"
                role="tabpanel"
                aria-labelledby="nav-code-tab"
              >
                Code content will appear here.
              </div>
              <div
                class="tab-pane fade"
                id="nav-process"
                role="tabpanel"
                aria-labelledby="nav-process-tab"
              >
                Procedure content will appear here.
              </div>
              <div
                class="tab-pane fade"
                id="nav-get"
                role="tabpanel"
                aria-labelledby="nav-get-tab"
              >
                What You Get content will appear here.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xl-4 col-xxl-5">
      <div class="custome-accordion">
        {% for module_name, lessons in grouped_lessons.items %}
        <div class="accordion-item card">
          <h2 class="accordion-header" id="heading{{ forloop.counter }}">
            <button
              class="accordion-button d-flex justify-content-between align-items-center collapsed"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#collapse{{ forloop.counter }}"
              aria-expanded="false"
              aria-controls="collapse{{ forloop.counter }}"
            >
              <span class="acc-heading">{{ module_name }}</span>
              <span class="ms-auto">({{ lessons|length }})</span>
            </button>
          </h2>
          <div
            id="collapse{{ forloop.counter }}"
            class="accordion-collapse collapse"
            aria-labelledby="heading{{ forloop.counter }}"
            data-bs-parent="#accordionExample"
          >
            <div class="accordion-body card-body pt-0">
              {% for lesson in lessons %}
              <div class="acc-courses">
                <div class="d-flex justify-content-between align-items-center">
                  <h4 class="m-0 lesson-heading" data-lesson-id="{{ lesson.id }}">
                    {{ lesson.heading }}
                  </h4>
                  <span>{{ lesson.serialno }}</span>
                </div>
              </div>
              {% endfor %}
              
              <!-- Separate heading for Exam availability -->
              {% with last_lesson=lessons|last %}
              {% if last_lesson.has_ques %}
                  <div class="acc-courses">
                      <div class="d-flex justify-content-between align-items-center">
                          <h4 class="m-0 lesson-heading exam-heading" data-lesson-id="{{ last_lesson.id }}">
                              Exam
                          </h4>
                      </div>
                  </div>
              {% endif %}
              {% endwith %}
              <div id="questions-container" class="mt-3"></div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  var playerReady = false; // Track if the player is ready

  // Load the IFrame Player API code asynchronously.
  var tag = document.createElement("script");
  tag.src = "https://www.youtube.com/iframe_api";
  var firstScriptTag = document.getElementsByTagName("script")[0];
  firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

  var player;

  // This function creates an <iframe> (and YouTube player) after the API code downloads.
  function onYouTubeIframeAPIReady() {
    player = new YT.Player("player", {
      height: "500",
      width: "100%",
      playerVars: {
        playsinline: 1,
      },
      events: {
        onReady: onPlayerReady,
        onStateChange: onPlayerStateChange,
      },
    });
  }

  // The API will call this function when the video player is ready.
  function onPlayerReady(event) {
    playerReady = true; // Set player ready to true
  }

  // The API calls this function when the player's state changes.
  var done = false;
  function onPlayerStateChange(event) {
    if (event.data == YT.PlayerState.PLAYING && !done) {
      setTimeout(stopVideo, 6000);
      done = true;
    }
  }

  function stopVideo() {
    if (player) {
      player.stopVideo();
    }
  }

  // Wait for the DOM to load
  $(document).ready(function () {
  $(".lesson-heading").on("click", function () {
    var lessonId = $(this).data("lesson-id");

    // Construct the URL using Django's URL template tag
    var url = "{% url 'get-lesson-details' 0 %}".replace("0", lessonId);

    // Make AJAX request to get full lesson details
    $.ajax({
      url: url,
      method: "GET",
      success: function (data) {
        // Populate the tabs with the fetched data
        $("#nav-about .about-content").html(data.about);
        $("#nav-reqmaterial").html(data.reqmaterial);
        $("#nav-digram").html(data.digram);
        $("#nav-code").html(data.code);
        $("#nav-process").html(data.process);
        $("#nav-get").html(data.get);

        // Show the video placeholder and hide it if there's a video
        if (playerReady && data.video) {
          $("#video-placeholder").hide(); // Hide the image
          player.loadVideoById(data.video);
          $("#player").show(); // Show the player
        } else {
          $("#video-placeholder").show(); // Show the image if no video
          player.stopVideo(); // Stop the player if it was previously loaded
          $("#player").hide(); // Ensure the player is hidden
        }

        // Update the progress bar
        updateProgressBar(lessonId);
      },
      error: function (xhr, status, error) {
        console.error("Error fetching lesson details:", error);
      },
    });
  });
   // Handle exam heading click
    $(".exam-heading").on("click", function () {
      var lessonId = $(this).data("lesson-id");
      var url = "{% url 'get-module-questions' 0 %}".replace("0", lessonId);
      
      $.ajax({
        url: url,
        method: "GET",
        success: function (data) {
          displayModuleQuestions(data.questions);
        },
        error: function (xhr, status, error) {
          console.error("Error fetching module questions:", error);
        },
      });
    });

    // Function to display questions
    function displayModuleQuestions(questions) {
      debugger;
    var questionsContainer = $("#questions-container");
    questionsContainer.empty();

    // Check if questions is defined and is an array
    if (Array.isArray(questions) && questions.length > 0) {
        questions.forEach(function (question) {
            questionsContainer.append(
                "<div class='question-item'>" +
                "<h5>" + question.question|safe + "</h5>" +
                "<ul>" +
                "<li>" + question.option1|safe + "</li>" +
                "<li>" + question.option2|safe + "</li>" +
                "<li>" + question.option3|safe + "</li>" +
                "<li>" + question.option4|safe + "</li>" +
                "</ul>" +
                "</div>"
            );
        });
    } else {
        // Handle case where there are no questions
        questionsContainer.append("<p>No questions available for this exam.</p>");
    }
}
// Handle exam heading click
    $(".exam-heading").on("click", function () {
      var lessonId = $(this).data("lesson-id");
      var url = "{% url 'get-module-questions' 0 %}".replace("0", lessonId);
      
      $.ajax({
        url: url,
        method: "GET",
        success: function (data) {
          displayModuleQuestions(data.questions);
        },
        error: function (xhr, status, error) {
          console.error("Error fetching module questions:", error);
        },
      });
    });

    // Function to display questions
    function displayModuleQuestions(questions) {
      var questionsContainer = $("#questions-container");
      questionsContainer.empty();
      if (questions.length > 0) {
        questions.forEach(function (question) {
          questionsContainer.append(
            "<div class='question-item'>" +
            "<h5>" + question.question_text + "</h5>" +
            "</div>"
          );
        });
      } else {
        questionsContainer.append("<p>No questions available for this exam.</p>");
      }
    }

    function updateProgressBar(lessonId) {
      // Make another AJAX request to update the progress bar
      $.ajax({
        url: "{% url 'save_lesson_watched' %}",
        method: "POST",
        data: {
          lesson_id: lessonId, // Pass the current lesson ID
          csrfmiddlewaretoken: "{{ csrf_token }}",
        },
        success: function (response) {
          if (response.success) {
            // Update the progress bar width based on new percentage
            var newPercentage = response.watched_percentage;
            var watchedLessons = response.watched_lessons;
            var totalLessons = response.total_lessons;

            // Update progress bar width only, without showing percentage inside it
            $(".progress-bar").css("width", newPercentage + "%");
            $(".progress-bar").attr("aria-valuenow", newPercentage);

            // Update the progress percentage outside the bar (in the h5 tag)
            $("h5.fs-14").text(newPercentage.toFixed(2) + "%");

            // Update the watched lessons count
            $("span.font-w600").text(watchedLessons + "/" + totalLessons);
          }
        },
        error: function (xhr, status, error) {
          console.error("Error updating progress:", error);
        },
      });
    }
  });
</script>
{% endblock content %}
